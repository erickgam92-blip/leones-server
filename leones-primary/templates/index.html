{% extends "base.html" %}
{% block content %}
<h1>Timeline</h1>

<section class="posts">
    {% for post in posts %}
        <article class="post card" data-post-id="{{ post.id }}">
            <header>
                <h2>{{ post.title }}</h2>
                <p class="meta">
                    por <a href="{{ url_for('profile', username=post.username) }}">{{ post.username }}</a>
                    췅 {{ post.created_at }}
                </p>
            </header>

            <p>{{ post.content }}</p>

            {% if post.image_filename %}
                <div class="post-image-wrapper">
                    <img src="{{ url_for('static', filename='uploads/' ~ post.image_filename) }}"
                         alt="Imagen del post"
                         class="post-image">
                </div>
            {% endif %}

            <div class="reactions-summary">
                Reacciones:
                游녨 <span id="react-like-{{ post.id }}">{{ post.reactions_by_type.get('like', 0) }}</span>
                仇벒잺 <span id="react-love-{{ post.id }}">{{ post.reactions_by_type.get('love', 0) }}</span>
                游땵 <span id="react-wow-{{ post.id }}">{{ post.reactions_by_type.get('wow', 0) }}</span>
                游땩 <span id="react-sad-{{ post.id }}">{{ post.reactions_by_type.get('sad', 0) }}</span>
                游땨 <span id="react-angry-{{ post.id }}">{{ post.reactions_by_type.get('angry', 0) }}</span>
                췅 Comentarios: <span id="comments-count-{{ post.id }}">{{ post.comments|length }}</span>
            </div>

            {% if user %}
            <div class="post-actions">
                <form method="post" action="{{ url_for('react_post', post_id=post.id) }}" data-react-form>
                    <button type="submit" name="reaction_type" value="like">游녨 Like</button>
                    <button type="submit" name="reaction_type" value="love">仇벒잺 Love</button>
                    <button type="submit" name="reaction_type" value="wow">游땵 Wow</button>
                    <button type="submit" name="reaction_type" value="sad">游땩 Sad</button>
                    <button type="submit" name="reaction_type" value="angry">游땨 Angry</button>
                </form>
                {% if admin_allowed %}
                    <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" onsubmit="return confirm('쯉eguro que quieres borrar este post?');">
                        <button type="submit" class="danger">Eliminar (admin)</button>
                    </form>
                {% endif %}
            </div>
            {% endif %}

            <section class="comments">
                <h3>Comentarios</h3>

                <ul class="comments-list" data-comments-list="{{ post.id }}">
                    {% set all_comments = post.comments %}
                    {% for c in all_comments if not c.parent_comment_id %}
                        <li class="comment" data-comment-id="{{ c.id }}">
                            <div>
                                <strong>
                                    <a href="{{ url_for('profile', username=c.username) }}">{{ c.username }}</a>
                                </strong>:
                                {{ c.content }}
                                <span class="comment-date">{{ c.created_at }}</span>
                            </div>
                            {% if user %}
                                <button type="button" class="reply-toggle" data-target="{{ c.id }}">Responder</button>
                                <form method="post"
                                      action="{{ url_for('comment_post', post_id=post.id) }}"
                                      class="comment-form reply-form"
                                      data-comment-form
                                      data-parent-id="{{ c.id }}"
                                      style="display:none; margin-left:1.5rem; margin-top:0.3rem;">
                                    <input type="text" name="content" placeholder="Responder..." required>
                                    <input type="hidden" name="parent_comment_id" value="{{ c.id }}">
                                    <button type="submit">Responder</button>
                                </form>
                            {% endif %}
                            <ul class="replies" data-replies-for="{{ c.id }}" style="margin-left:1.5rem; margin-top:0.3rem;">
                                {% for r in all_comments if r.parent_comment_id == c.id %}
                                    <li class="comment-reply" data-comment-id="{{ r.id }}">
                                        <strong>
                                            <a href="{{ url_for('profile', username=r.username) }}">{{ r.username }}</a>
                                        </strong>:
                                        {{ r.content }}
                                        <span class="comment-date">{{ r.created_at }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>

                {% if user %}
                <!-- Comentario ra칤z (no es respuesta) -->
                <form method="post"
                      action="{{ url_for('comment_post', post_id=post.id) }}"
                      class="comment-form"
                      data-comment-form>
                    <input type="text" name="content" placeholder="Escribe un comentario..." required>
                    <input type="hidden" name="parent_comment_id" value="">
                    <button type="submit">Comentar</button>
                </form>
                {% endif %}
            </section>
        </article>
    {% else %}
        <div class="card">
            <p>A칰n no hay posts.</p>
        </div>
    {% endfor %}
</section>

<script>
function updateReactionsUI(data) {
    const postId = data.post_id;
    const reactions = data.reactions || {};
    const commentsCount = data.comments_count || 0;

    const likeSpan   = document.getElementById("react-like-"   + postId);
    const loveSpan   = document.getElementById("react-love-"   + postId);
    const wowSpan    = document.getElementById("react-wow-"    + postId);
    const sadSpan    = document.getElementById("react-sad-"    + postId);
    const angrySpan  = document.getElementById("react-angry-"  + postId);
    const commentsSpan = document.getElementById("comments-count-" + postId);

    if (likeSpan)   likeSpan.textContent   = reactions.like  || 0;
    if (loveSpan)   loveSpan.textContent   = reactions.love  || 0;
    if (wowSpan)    wowSpan.textContent    = reactions.wow   || 0;
    if (sadSpan)    sadSpan.textContent    = reactions.sad   || 0;
    if (angrySpan)  angrySpan.textContent  = reactions.angry || 0;
    if (commentsSpan) commentsSpan.textContent = commentsCount;
}

// REACCIONES (AJAX, respeta qu칠 bot칩n se us칩)
document.querySelectorAll("form[data-react-form]").forEach(form => {
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitter = e.submitter;
        const formData = new FormData(form);
        if (submitter && submitter.name) {
            formData.set(submitter.name, submitter.value);
        }

        try {
            const res = await fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {"X-Requested-With": "XMLHttpRequest"}
            });
            if (!res.ok) {
                if (res.status === 403) {
                    const data = await res.json().catch(() => null);
                    if (data && data.error === "restricted") {
                        alert("Est치s restringido hasta: " + (data.until || "m치s tarde") + ". No puedes reaccionar.");
                    }
                }
                return;
            }
            const data = await res.json();
            if (data.ok) {
                updateReactionsUI(data);
            }
        } catch (err) {
            console.error(err);
        }
    });
});

// Toggle de formularios de respuesta
document.querySelectorAll(".reply-toggle").forEach(btn => {
    btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-target");
        const form = document.querySelector(`form.reply-form[data-parent-id="${id}"]`);
        if (form) {
            form.style.display = form.style.display === "none" ? "flex" : "none";
        }
    });
});

// COMENTARIOS (ra칤z y respuestas) por AJAX
document.querySelectorAll("form[data-comment-form]").forEach(form => {
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        try {
            const res = await fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {"X-Requested-With": "XMLHttpRequest"}
            });
            if (!res.ok) {
                if (res.status === 403) {
                    const data = await res.json().catch(() => null);
                    if (data && data.error === "restricted") {
                        alert("Est치s restringido hasta: " + (data.until || "m치s tarde") + ". No puedes comentar.");
                    }
                }
                return;
            }
            const data = await res.json();
            if (!data.ok) return;

            const c = data.comment;
            const postId = data.post_id;

            if (c.parent_comment_id) {
                // es respuesta
                const repliesUl = document.querySelector('ul[data-replies-for="' + c.parent_comment_id + '"]');
                if (repliesUl) {
                    const li = document.createElement("li");
                    li.className = "comment-reply";
                    li.setAttribute("data-comment-id", c.id);
                    li.innerHTML = `<strong><a href="/profile/${encodeURIComponent(c.username)}">${c.username}</a></strong>: ${c.content} <span class="comment-date">${c.created_at}</span>`;
                    repliesUl.appendChild(li);
                }
            } else {
                // comentario ra칤z nuevo
                const list = document.querySelector('ul[data-comments-list="' + postId + '"]');
                if (list) {
                    const li = document.createElement("li");
                    li.className = "comment";
                    li.setAttribute("data-comment-id", c.id);
                    li.innerHTML = `
                        <div>
                            <strong><a href="/profile/${encodeURIComponent(c.username)}">${c.username}</a></strong>:
                            ${c.content}
                            <span class="comment-date">${c.created_at}</span>
                        </div>
                        ${document.body.dataset.loggedIn ? `
                        <button type="button" class="reply-toggle" data-target="${c.id}">Responder</button>
                        <form method="post"
                              action="/posts/${postId}/comment"
                              class="comment-form reply-form"
                              data-comment-form
                              data-parent-id="${c.id}"
                              style="display:none; margin-left:1.5rem; margin-top:0.3rem;">
                            <input type="text" name="content" placeholder="Responder..." required>
                            <input type="hidden" name="parent_comment_id" value="${c.id}">
                            <button type="submit">Responder</button>
                        </form>
                        ` : ``}
                        <ul class="replies" data-replies-for="${c.id}" style="margin-left:1.5rem; margin-top:0.3rem;"></ul>
                    `;
                    list.appendChild(li);

                    // volver a enganchar el listener del bot칩n "Responder" nuevo
                    const replyBtn = li.querySelector(".reply-toggle");
                    if (replyBtn) {
                        replyBtn.addEventListener("click", () => {
                            const id = replyBtn.getAttribute("data-target");
                            const formReply = li.querySelector(`form.reply-form[data-parent-id="${id}"]`);
                            if (formReply) {
                                formReply.style.display = formReply.style.display === "none" ? "flex" : "none";
                            }
                        });
                    }
                }
            }

            const commentsSpan = document.getElementById("comments-count-" + postId);
            if (commentsSpan) commentsSpan.textContent = data.comments_count;

            form.reset();
        } catch (err) {
            console.error(err);
        }
    });
});

// refresco de seguridad cada 5s (reacciones + conteo de comentarios)
async function refreshReactionsAndComments() {
    try {
        const res = await fetch("{{ url_for('reactions_summary') }}", {cache: "no-store"});
        if (!res.ok) return;
        const data = await res.json();
        data.forEach(updateReactionsUI);
    } catch (e) {}
}
setInterval(refreshReactionsAndComments, 5000);
</script>

{% endblock %}
